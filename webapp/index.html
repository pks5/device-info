<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.12.0/css/xterm.min.css">

    <title>Device Info - Raspilab Experiments</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
      html{
        height:100%;
        
      }
      body{
        background-image: url('./img/bg.jpg');
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        padding-top:70px;
        font-family: 'Roboto', sans-serif;

        
      }

      

      #terminal{
          background-color: black;
          overflow: hidden;
      }


      .gaugeChart-bezel-outer {
    fill: none;
    stroke: black;
  }

  .gaugeChart-bezel-inner {
   fill:none;
    
  }

  .gaugeChart-tick {
    fill: none;
    stroke: black;
  }

  .gaugeChart-face,
  .gaugeChart-tickHider {
    stroke-width: 0;
    fill: white;
  }

  .gaugeChart-needle {
    stroke: #CD4120;
    fill: #E57358;
    opacity: 0.8;
    transition: transform 0.5s ease-in-out;
   
  }

  .gaugeChart-needle-cap {
    stroke: #666666;
    fill: #4684EE;
  }
    </style>
  </head>
  <body>
    
    <nav class="navbar fixed-top navbar-light bg-light navbar-expand-md">
      <div class="container-fluid">
        <a id="navbar-brand" class="navbar-brand" href="#"><span id="os-icon" class="fab fa-linux"></span>&nbsp;<span id="device-status"></span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarText">
          <small class="navbar-text">
            since <span id="last-com-connect"></span> UTC
          </small>
          
          
          
          <div class="me-1 navbar-text"><span id="kpi-led-status">disabled</span></div>
            
          
          
          <div class="d-flex ms-auto align-items-center">
            
            <i class="fas fa-microchip me-1"></i>
            <select class="form-select me-1" id="deviceSelect">
              <option selected>Select Device</option>
            </select>
            <div id="system-buttons" class="d-flex" style="display: none;">
              <button class="btn btn-outline-dark me-1" id="shutdown-button"><i class="fas fa-power-off"></i></button>
              <button class="btn btn-outline-dark me-1" id="reboot-button"><i class="fas fa-sync-alt"></i></button>
              <button class="btn btn-outline-dark me-1" id="exit-button"><i class="fas fa-door-open"></i></button>
              <button class="btn btn-outline-dark" id="devtools-button"><i class="fas fa-tools"></i></button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col" id="cpu-gauge">
          
        </div>
        <div class="col" id="memory-gauge">
          
        </div>
        <div class="col" id="disk-gauge">
          
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Deployments <span id="kpi-deployments" class="badge bg-secondary"></span></h5>
              <h6 class="card-subtitle mb-2 text-muted">User Apps deployed on this device</h6>
            </div>
            <ul id="deployments-list" class="list-group list-group-flush">
              
            </ul>
          </div>
        </div>
        <div class="col-md mt-2 mt-md-0">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Apps <span id="kpi-apps-running" class="badge bg-secondary"></span></h5>
              <h6 class="card-subtitle mb-2 text-muted">Apps running on this device</h6>
            </div>
            <ul id="apps-list" class="list-group list-group-flush">
              
            </ul>
          </div>
        </div>
        <div class="col-md mt-2 mt-md-0">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Scripts <span id="kpi-scripts-running" class="badge bg-secondary"></span></h5>
              <h6 class="card-subtitle mb-2 text-muted">Scripts running on this device</h6>
            </div>
            <ul id="scripts-list" class="list-group list-group-flush">
              
            </ul>
          </div>
        </div>
      </div>
    </div>


    <div id="terminal" class="p-2 mt-3">
        <div id="xterm-container"></div>
      </div>
    

    

      
    

    <!-- Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="statusModalLabel">Error</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ...
          </div>
          <div class="modal-footer">
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@4.12.0/lib/xterm.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@6.1.0/bundles/stomp.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.2.1/dist/d3.min.js"></script>
    <script src="js/gauge.js"></script>
    <script src="js/conic-gradient.js"></script>
    <script>
        const oConfig = {
          appId: "net.raspilab.experiments.device_info",
          deviceHostName: "jojojo",
          authClientId: "growcab_local"
        };

        const term = new Terminal();
        term.open(document.getElementById('xterm-container'));

        const elStatusModal = new bootstrap.Modal(document.getElementById('statusModal'), {
          backdrop: "static"
        });
        
        let oFeatureHub;

        let fnConnect = function(){
            DeviceSelection.init();
            
            oFeatureHub = new FeatureHub({
                appId: oConfig.appId,
                clientId: oConfig.authClientId
            });

            //TODO
            oFeatureHub.m_oSocketClient.addEventListener("socketClose", () => {
                elStatusModal.show(); 

                term.writeln("UI Socket Disconnected.");
            });

            oFeatureHub.addEventListener("connect", () => {
                elStatusModal.hide();

                term.writeln("UI Socket Connected.");
            });

            oFeatureHub.connect(oServerInfo => {
                oFeatureHub.devices(DeviceSelection.onReceiveDevices);

                

                term.writeln("Connected to " + oServerInfo.webSocketUrl);
            });
        };

        let scriptLocation = 'https://my.featurehub.net/lib/v1/fhub.js';

        if(location.hostname.indexOf('.localnet') !== -1){
          //  scriptLocation = 'http://my.featurehub.localnet:8787/lib/v1/fhub.js';
        }

        const script = document.createElement('script');
        script.src = scriptLocation;
        script.addEventListener('load', fnConnect);
        document.body.appendChild(script);

        let DeviceSelection = {};

        DeviceSelection.init = function(){
            let elSelect = document.getElementById("deviceSelect");
            elSelect.addEventListener("change", DeviceSelection.onSelectDevice);

            DeviceSelection.elSelect = elSelect;
        };

        DeviceSelection.onReceiveDevices = function(oData){
          let elSelect = DeviceSelection.elSelect,
              sCurrentValue = elSelect.value,
              bCurrentValueFound = false;

          elSelect.innerHTML = "";

          elOpt = document.createElement('option');
          elOpt.innerHTML = "Select Device";
          elSelect.appendChild(elOpt);

          for (let i = 0; i<oData.devices.length; i++){
            let oDevice = oData.devices[i], 
                elOpt = document.createElement('option');
            
            elOpt.value = oDevice.machineId;
            elOpt.innerHTML = oDevice.hostName;
            elSelect.appendChild(elOpt);

            if(sCurrentValue && oDevice.machineId === sCurrentValue){
              bCurrentValueFound = true;
              elOpt.selected = true;
            }
          }

          if(!bCurrentValueFound){
            sCurrentValue = null;
          }

          if(!sCurrentValue){
            if(oData.devices.length === 1){
                elSelect.value = oData.devices[0].machineId;
            }
            else if (window.BletaElectron) {
                elSelect.value = BletaElectron.getMachineId();
				    }
            else{
                for (let i = 0; i<oData.devices.length; i++){
                    let oDevice = oData.devices[i];
                    if(oDevice.hostName === oConfig.deviceHostName){
                      elSelect.value = oDevice.machineId;
                    }
                }
            }

            DeviceSelection.onSelectDevice();
          }

          
        };

        DeviceSelection.onSelectDevice = function(){
          let sMachineId = DeviceSelection.elSelect.value;
          
          if(sMachineId){
            DeviceSelection.selectDevice(sMachineId);
          }
        };

        DeviceSelection.selectDevice = function(sMachineId){
            term.clear();

          /*
            * Setup Default Target
            */
            oFeatureHub.setDefaultTarget({
              device: sMachineId
            });


            oFeatureHub.device(sMachineId, function(oData){
                  console.log(oData);
                  const elLastComConnect = document.getElementById("last-com-connect");
                  elLastComConnect.textContent = new Date(oData.device.lastComConnectDate).toLocaleString("en-US", { timeZone: 'UTC' });

                  document.getElementById("kpi-deployments").textContent = oData.device.apps.length;

                  let elListItem,
                    elListItemCell;

                  const elDeployments = document.getElementById("deployments-list");
                  
                    for(var i = 0; i < oData.device.apps.length; i++){
                        const oApp = oData.device.apps[i];

                            

                            elListItem = document.createElement("li");
                          elListItem.className = "list-group-item";

                          
                          elListItemCell = document.createElement("small");
                          elListItemCell.className = "float-end";
                          elListItem.append(elListItemCell);
                          elListItemCell.textContent = oData.appsToStart.indexOf(oApp.appId) !== -1;


                          elListItemCell = document.createElement("div");
                          elListItem.append(elListItemCell);
                          elListItemCell.textContent = oApp.name;

                          elListItemCell = document.createElement("small");
                          elListItem.append(elListItemCell);
                          elListItemCell.textContent = oApp.appId;
                          
                          elDeployments.append(elListItem);
                    }
            }, function(){

            });

            /*
            * Subscribe to Console
            */
            oFeatureHub.unsubscribe('deviceConsole');
            oFeatureHub.subscribe('deviceConsole', sMachineId + "/console", function(oData, mHeaders){
                term.writeln(oData.args[0]); 
            });

            /*
            * Subscribe to Device Status
            */
            oFeatureHub.unsubscribe('deviceStatus');
            oFeatureHub.subscribe('deviceStatus', sMachineId, onReceiveDeviceStatus);

            oFeatureHub.send({ method:"requestStatus" }, { });

            fnGetSystemInfo();
        };

        /*
        * Triggered when a Device Status Message has been received
        */ 
         const elDeviceStatus = document.getElementById("device-status"),
              elNavBarBrand = document.getElementById("navbar-brand"),
         elSystemButtons = document.getElementById("system-buttons");

         const oCpuGauge = new Gauge({
                    el: '#cpu-gauge',
                    label: 'CPU'
                  }),
                oMemoryGauge = new Gauge({
                    el: '#memory-gauge',
                    label: 'Memory'
                  }),
                oDiskGauge = new Gauge({
                    el: '#disk-gauge',
                    label: 'Disk'
                  });

        let onReceiveDeviceStatus = function(oData, mHeaders){
            

            let sFrom = new URL(mHeaders["fh-from"]),
                aPathParts = sFrom.pathname.split("/"),
                sMachineId = aPathParts[aPathParts.length-1],
                sPhappId = sFrom.searchParams.get("app");

                console.log('STATUS', sPhappId, oData, mHeaders);

            if(!sPhappId){
                oDeviceStatus = oData.status;
                //A message without the PyApp id
                //Information from the device itself
                if(oData.connected){
                    console.log("Device %s is connected.", sMachineId);
                    
                    elDeviceStatus.innerHTML = oData.hostInfo.hostName;
                    elNavBarBrand.classList.add("text-success");
                    elNavBarBrand.classList.remove("text-danger");
                    elSystemButtons.style.display = "block";
                }
                else{
                    
                    console.log("Device %s is disconnected.", sMachineId);
                    elDeviceStatus.innerHTML = "DISCONNECTED";
                    elNavBarBrand.classList.remove("text-success");
                    elNavBarBrand.classList.add("text-danger");
                    elSystemButtons.style.display = "none";

                    oCpuGauge.setValue();
                    oMemoryGauge.setValue();
                    oDiskGauge.setValue();
                }

                


                const elScriptsList = document.getElementById("scripts-list"),
                  elAppsList = document.getElementById("apps-list"),
                  elKpiAppsRunning = document.getElementById("kpi-apps-running"),
                  elKpiScriptsRunning = document.getElementById("kpi-scripts-running");

                elScriptsList.replaceChildren();
                elAppsList.replaceChildren();

                if(oDeviceStatus){
                  elKpiAppsRunning.innerHTML = oDeviceStatus.appsRunning;
                  elKpiAppsRunning.style.display = 'inline-block';
                  elKpiScriptsRunning.innerHTML = oDeviceStatus.scriptsRunning;
                  elKpiScriptsRunning.style.display = 'inline-block';
                  document.getElementById("kpi-led-status").innerHTML = oData.ledStatusEnabled ? "enabled" : "disabled";
                  
                  let elListItem,
                    elListItemCell;
                  for(var i = 0; i < oDeviceStatus.apps.length; i++){
                      var oApp = oDeviceStatus.apps[i];

                      

                      elListItem = document.createElement("li");
                          elListItem.className = "list-group-item";

                          elListItemCell = document.createElement("small");
                          elListItemCell.className = "float-end";
                          elListItem.append(elListItemCell);
                          elListItemCell.textContent = "stop";


                          elListItemCell = document.createElement("div");
                          elListItem.append(elListItemCell);
                          elListItemCell.textContent = oApp.appId;

                         

                      elAppsList.append(elListItem);

                      for(let j = 0; j < oApp.scripts.length; j++){
                          let oScript = oApp.scripts[j];
                          
                          elListItem = document.createElement("li");
                          elListItem.className = "list-group-item";

                          elListItemCell = document.createElement("small");
                          elListItemCell.className = "float-end";
                          elListItem.append(elListItemCell);
                          elListItemCell.textContent = oScript.pid;


                          elListItemCell = document.createElement("div");
                          elListItem.append(elListItemCell);
                          elListItemCell.textContent = oScript.path;

                          elListItemCell = document.createElement("small");
                          elListItem.append(elListItemCell);
                          elListItemCell.textContent = oApp.appId;
                          
                          elScriptsList.append(elListItem);
                      }
                  }
                  
                  
                }
                else{
                  elKpiAppsRunning.style.display = 'none';
                  elKpiScriptsRunning.style.display = 'none';
                  document.getElementById("kpi-led-status").innerHTML = "";
                }
            }
            else if(sPhappId === "net.featurehub.phapp.sys"){
                if(oData.cpu){
                  oCpuGauge.setValue(Number(oData.cpu.utilization).toFixed(1));
                }
                else{
                  oCpuGauge.setValue();
                }

                if(oData.memory){
                  oMemoryGauge.setValue(Number(100 - 100* oData.memory.virtual.available/oData.memory.virtual.total).toFixed(1));
                }
                else{
                  oMemoryGauge.setValue();
                }

                if(oData.disk){
                  oDiskGauge.setValue(Number(oData.disk.usage.percent).toFixed(1));
                }
                else{
                  oDiskGauge.setValue();
                }
            }
            else{
                //Ignore messages from other PyApps on this device
            }
            
        };

         /*
        * Buttons
        */
        let elShutdownButton = document.getElementById("shutdown-button"),
            elRebootButton = document.getElementById("reboot-button"),
            elExitButton = document.getElementById("exit-button"),
            elDevToolsButton = document.getElementById("devtools-button");

        /*
        * Shutdown Button Click Handler
        */    
        elShutdownButton.addEventListener("click", function(){
            oFeatureHub.send({ "app":"net.featurehub.phapp.sys", "script":"power.py", method: "sendMessage" }, { "action": "SHUTDOWN" });
        });

        /*
        * Reboot Button Click Handler
        */
        elRebootButton.addEventListener("click", function(){
            oFeatureHub.send({ "app":"net.featurehub.phapp.sys", "script":"power.py", method: "sendMessage" }, { "action": "REBOOT" });
        });

        elExitButton.addEventListener("click", function(){
            oFeatureHub.send({ method: "exitGracefully" }, {});
        });

        elDevToolsButton.addEventListener("click", function(){
            oFeatureHub.send({ method: "toggleDevTools" }, {});
        });

        const fnGetSystemInfo = () => {
          oFeatureHub.send({ "app":"net.featurehub.phapp.sys", "script":"sysinfo.py", method: "sendMessage" }, { "action": "STATUS" });
        };

        setInterval(fnGetSystemInfo, 10000);
        
    </script>

    
    
  </body>
</html>
